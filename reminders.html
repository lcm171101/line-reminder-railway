
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>提醒清單 - LINE Reminder Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow rounded-4 p-4">
      <h2 class="mb-4">提醒清單</h2>
      <div class="mb-3 d-flex justify-content-between">
        <input type="text" id="searchInput" class="form-control w-50 me-3" placeholder="搜尋姓名或內容…">
        <button class="btn btn-success" onclick="downloadCSV()">📤 匯出 CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>姓名</th>
              <th>時間</th>
              <th>內容</th>
              <th>週期</th>
              <th>到期日</th>
              <th>設定者</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="reminder-body">
            <tr><td colspan="7">載入中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let rawData = [];

    function renderTable(data) {
      const body = document.getElementById("reminder-body");
      body.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || ""}</td>
          <td>${r.time || ""}</td>
          <td>${r.message || ""}</td>
          <td>${r.repeatType || ""}</td>
          <td>${r.expireDate || ""}</td>
          <td>${r.createdBy || ""}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteReminder('${r.id}')">刪除</button>
          </td>
        </tr>
      `).join("");
    }

    function downloadCSV() {
      let csv = "姓名,時間,內容,週期,到期日,設定者\n";
      rawData.forEach(r => {
        csv += `${r.name || ""},${r.time || ""},${r.message || ""},${r.repeatType || ""},${r.expireDate || ""},${r.createdBy || ""}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "reminders.csv";
      link.click();
    }

    function deleteReminder(id) {
      if (confirm("確認刪除此提醒？")) {
        fetch("/api/reminders/" + id, { method: "DELETE" })
          .then(res => res.ok ? location.reload() : alert("刪除失敗"));
      }
    }

    fetch("/api/reminders")
      .then(res => res.json())
      .then(data => {
        rawData = data;
        renderTable(data);
      });

    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      const filtered = rawData.filter(r =>
        (r.name || "").toLowerCase().includes(keyword) ||
        (r.message || "").toLowerCase().includes(keyword)
      );
      renderTable(filtered);
    });
  </script>
</body>
</html>
