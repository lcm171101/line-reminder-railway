
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>提醒事項 - LINE Reminder Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    td, th { vertical-align: middle; white-space: nowrap; }
    td.wrap { white-space: normal; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow rounded-4 p-4">
      <h2 class="mb-4 text-primary">提醒事項</h2>
      <div class="mb-3 d-flex justify-content-between flex-wrap gap-3">
        <input type="text" id="searchInput" class="form-control flex-fill" placeholder="🔍 搜尋姓名 / 分類 / 內容…" style="max-width: 350px;">
        <button class="btn btn-success" onclick="downloadCSV()">📤 匯出 CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>姓名</th>
              <th>主分類</th>
              <th>次分類</th>
              <th>時間</th>
              <th class="text-start">內容</th>
              <th>週期</th>
              <th>到期日</th>
              <th>設定者</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="reminder-body">
            <tr><td colspan="9">📄 載入中…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let rawData = [];

    function renderTable(data) {
      const body = document.getElementById("reminder-body");
      if (data.length === 0) {
        body.innerHTML = '<tr><td colspan="9">❌ 找不到資料</td></tr>';
        return;
      }
      body.innerHTML = data.map(r => `
        <tr>
          <td>${r.name || ""}</td>
          <td>${r.mainCategory || ""}</td>
          <td>${r.subCategory || ""}</td>
          <td>${r.time || ""}</td>
          <td class="wrap text-start">${r.message || ""}</td>
          <td>${r.repeatType || ""}</td>
          <td>${r.expireDate || ""}</td>
          <td>${r.createdBy || ""}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteReminder('${r.id}')">🗑 刪除</button>
          </td>
        </tr>
      `).join("");
    }

    function downloadCSV() {
      let csv = "姓名,主分類,次分類,時間,內容,週期,到期日,設定者\n";
      rawData.forEach(r => {
        csv += `${r.name || ""},${r.mainCategory || ""},${r.subCategory || ""},${r.time || ""},${r.message || ""},${r.repeatType || ""},${r.expireDate || ""},${r.createdBy || ""}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "reminders.csv";
      link.click();
    }

    function deleteReminder(id) {
      if (confirm("確認刪除此提醒？")) {
        fetch("/api/reminders/" + id, { method: "DELETE" })
          .then(res => res.ok ? location.reload() : alert("刪除失敗"));
      }
    }

    fetch("/api/reminders")
      .then(res => res.json())
      .then(data => {
        rawData = data;
        renderTable(data);
      });

    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      const filtered = rawData.filter(r =>
        (r.name || "").toLowerCase().includes(keyword) ||
        (r.message || "").toLowerCase().includes(keyword) ||
        (r.mainCategory || "").toLowerCase().includes(keyword) ||
        (r.subCategory || "").toLowerCase().includes(keyword)
      );
      renderTable(filtered);
    });
  </script>
</body>
</html>
